<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Substance Use - Effective Age Calculator</title>
    <meta name="description" content="Estimate your biological age based on lifestyle factors like smoking, alcohol consumption, and recreational drug use. Get personalized insights and health recommendations.">
    <meta name="keywords" content="biological age, health calculator, smoking effects, alcohol effects, drug effects, health assessment">
    <meta name="author" content="Health Insights">
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-your-publisher-id" crossorigin="anonymous"></script>
    
    <style>
        :root {
            --primary-green: #2E8B57;
            --secondary-green: #66CDAA;
            --light-green: #E8F6EF;
            --white: #FFFFFF;
            --dark-text: #333333;
            --light-gray: #f5f5f5;
            --border-gray: #ddd;
            --error-red: #dc3545;
            --card-bg: #FFFFFF;
            --background: #F9F9F9;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --dark-text: #F5F5F5;
                --light-gray: #2A2A2A;
                --border-gray: #444;
                --card-bg: #2D2D2D;
                --background: #1E1E1E;
                --light-green: #1C3B2A;
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: var(--dark-text);
            background-color: var(--background);
            padding: 1rem;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-gray);
        }

        h1 {
            color: var(--primary-green);
            margin-bottom: 0.5rem;
        }

        .tagline {
            color: var(--dark-text);
            font-size: 1.1rem;
        }

        /* Main Layout */
        .main-wrapper {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        @media (min-width: 768px) {
            .main-wrapper {
                flex-direction: row;
            }
            .calculator-form {
                flex: 1;
            }
            .results-panel {
                flex: 1;
            }
        }

        /* Smoking Badge */
        .smoking-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        @media (prefers-color-scheme: dark) {
            .smoking-badge {
                background-color: #5C4A00;
                border-color: #7A5F00;
                color: #FFD54F;
            }
        }

        .badge-icon {
            flex-shrink: 0;
        }

        /* Form Styles */
        .form-section {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .form-section h2 {
            color: var(--primary-green);
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            font-size: 1rem;
            background-color: var(--card-bg);
            color: var(--dark-text);
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 2px rgba(46, 139, 87, 0.2);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        /* Tooltips */
        .tooltip-trigger {
            display: inline-block;
            background-color: var(--primary-green);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 0.8rem;
            cursor: help;
            margin-left: 0.25rem;
        }

        .tooltip {
            display: none;
            position: absolute;
            background-color: var(--dark-text);
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            max-width: 250px;
            z-index: 100;
        }

        .tooltip-trigger:hover + .tooltip,
        .tooltip-trigger:focus + .tooltip {
            display: block;
        }

        /* Buttons */
        .btn-primary,
        .btn-secondary {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .btn-primary {
            background-color: var(--primary-green);
            color: white;
        }

        .btn-primary:hover {
            background-color: #267349;
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--primary-green);
            border: 1px solid var(--primary-green);
        }

        .btn-secondary:hover {
            background-color: var(--light-green);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        /* Drug Entry */
        .drug-entry {
            background-color: var(--light-gray);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            border: 1px solid var(--border-gray);
        }

        #addDrugBtn {
            margin-bottom: 1rem;
        }

        /* Disclaimer */
        .disclaimer {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin-top: 1.5rem;
            font-size: 0.9rem;
        }

        @media (prefers-color-scheme: dark) {
            .disclaimer {
                background-color: #5C4A00;
                border-left-color: #FFC107;
                color: #FFD54F;
            }
        }

        .disclaimer p {
            margin: 0;
        }

        /* Results Panel */
        .results-panel {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .results-panel h2 {
            color: var(--primary-green);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        /* Age Gauge */
        .age-gauge {
            margin-bottom: 2rem;
            text-align: center;
        }

        .gauge-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .gauge-bar {
            height: 30px;
            background-color: var(--light-gray);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-gray);
        }

        .gauge-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-green), var(--primary-green));
            border-radius: 15px;
            transition: width 1s ease-in-out;
        }

        /* Breakdown List */
        .results-breakdown {
            margin-bottom: 1.5rem;
        }

        .results-breakdown h3 {
            color: var(--primary-green);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        #breakdownList {
            list-style: none;
            margin-bottom: 1rem;
        }

        #breakdownList li {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-gray);
            display: flex;
            justify-content: space-between;
        }

        .total-deduction {
            font-weight: 600;
            text-align: right;
            font-size: 1.1rem;
        }

        /* Risk Indicator */
        .risk-indicator {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
        }

        .risk-low {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .risk-moderate {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .risk-high {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        @media (prefers-color-scheme: dark) {
            .risk-low {
                background-color: #1C3B28;
                border-color: #2A4D3D;
                color: #4CAF50;
            }
            .risk-moderate {
                background-color: #5C4A00;
                border-color: #7A5F00;
                color: #FFD54F;
            }
            .risk-high {
                background-color: #5C1A25;
                border-color: #7A2333;
                color: #F44336;
            }
        }

        /* Resources */
        .resources {
            font-size: 0.9rem;
        }

        .resources h3 {
            color: var(--primary-green);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .resources ul {
            list-style: none;
            margin-top: 0.5rem;
        }

        .resources li {
            margin-bottom: 0.5rem;
        }

        .resources a {
            color: var(--primary-green);
            text-decoration: none;
        }

        .resources a:hover {
            text-decoration: underline;
        }

        /* Loading State */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        /* Error Message */
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }

        @media (prefers-color-scheme: dark) {
            .error-message {
                background-color: #5C1A25;
                color: #F88D98;
            }
        }

        /* Ad Container */
        .ad-container {
            margin: 2rem 0;
            text-align: center;
            min-height: 90px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--light-gray);
            border-radius: 8px;
            overflow: hidden;
        }

        /* Footer */
        footer {
            margin-top: 3rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-gray);
            text-align: center;
            font-size: 0.9rem;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .footer-links a {
            color: var(--primary-green);
            text-decoration: none;
        }

        .footer-links a:hover {
            text-decoration: underline;
        }

        /* Cookie Consent */
        .cookie-consent {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            color: var(--dark-text);
            padding: 1rem;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }

        .cookie-consent p {
            margin-bottom: 1rem;
        }

        .cookie-buttons {
            display: flex;
            gap: 1rem;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: var(--primary-green);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Effective Age Calculator</h1>
            <p class="tagline">Estimate the impact of substance use on your biological age.</p>
        </header>

        <!-- Google AdSense Ad Unit -->
        <div class="ad-container">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-your-publisher-id"
                 data-ad-slot="your-ad-slot-id"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>

        <main class="main-wrapper">
            <!-- Top-Left Smoking Badge (the "left up smoking" requirement) -->
            <div class="smoking-badge" id="smokingBadge" aria-hidden="true" style="display: none;">
                <svg class="badge-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 10C18 6.69 15.31 4 12 4C8.69 4 6 6.69 6 10V16H18V10Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M18 16H6V18C6 19.1 6.9 20 8 20H16C17.1 20 18 19.1 18 18V16Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M10 10H14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M10 13H14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span class="badge-text">Smoking effect: <span id="smokingDeduction">-0</span> yrs</span>
            </div>

            <form id="ageCalculatorForm" class="calculator-form">
                <div class="form-section">
                    <h2>Basic Information</h2>
                    <div class="input-group">
                        <label for="age">Chronological Age (years) *</label>
                        <input type="number" id="age" name="age" min="10" max="120" required aria-required="true">
                    </div>
                    <div class="input-group">
                        <label for="sex">Sex (Optional)</label>
                        <select id="sex" name="sex">
                            <option value="">Prefer not to say</option>
                            <option value="female">Female</option>
                            <option value="male">Male</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-section">
                    <h2>Smoking</h2>
                    <div class="input-group">
                        <label for="smokingType">Type</label>
                        <select id="smokingType" name="smoking.type">
                            <option value="">Not a smoker</option>
                            <option value="cigarette">Cigarettes</option>
                            <option value="e-cigarette">E-Cigarette / Vape</option>
                            <option value="cigar">Cigar</option>
                            <option value="pipe">Pipe</option>
                        </select>
                    </div>
                    <div class="input-group" id="cigarettesGroup" style="display: none;">
                        <label for="cigarettesPerDay">Cigarettes per day</label>
                        <input type="number" id="cigarettesPerDay" name="smoking.cigarettes_per_day" min="0" value="0">
                    </div>
                    <div class="input-group" id="smokingYearsGroup" style="display: none;">
                        <label for="smokingYears">Years smoking</label>
                        <input type="number" id="smokingYears" name="smoking.years" min="0" value="0">
                    </div>
                </div>

                <div class="form-section">
                    <h2>Alcohol Consumption</h2>
                    <div class="input-group">
                        <label for="drinksPerWeek">Standard drinks per week
                            <span class="tooltip-trigger" aria-describedby="drinkDefTooltip">(?)</span>
                        </label>
                        <div id="drinkDefTooltip" class="tooltip" role="tooltip">A standard drink contains about 14g of pure alcohol (e.g., 12oz beer, 5oz wine, 1.5oz spirit).</div>
                        <input type="number" id="drinksPerWeek" name="alcohol.drinks_per_week" min="0" value="0">
                    </div>
                    <div class="input-group">
                        <label for="bingePerMonth">Binge episodes per month (optional)
                            <span class="tooltip-trigger" aria-describedby="bingeDefTooltip">(?)</span>
                        </label>
                        <div id="bingeDefTooltip" class="tooltip" role="tooltip">5+ drinks for men or 4+ drinks for women on a single occasion.</div>
                        <input type="number" id="bingePerMonth" name="alcohol.binge_per_month" min="0" value="0">
                    </div>
                </div>

                <div class="form-section" id="drugsSection">
                    <h2>Recreational Drug Use (Optional)</h2>
                    <button type="button" id="addDrugBtn" class="btn-secondary">+ Add Another Substance</button>
                    <div class="drug-entry">
                        <div class="input-group">
                            <label>Substance</label>
                            <select name="drugs[0].name" class="drug-name">
                                <option value="cannabis">Cannabis (Marijuana)</option>
                                <option value="cocaine">Cocaine</option>
                                <option value="amphetamines">Amphetamines</option>
                                <option value="opioids">Opioids</option>
                                <option value="mdma">MDMA (Ecstasy)</option>
                                <option value="synthetic_cannabinoids">Synthetic Cannabinoids</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Frequency</label>
                            <select name="drugs[0].frequency" class="drug-frequency">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Years of use</label>
                            <input type="number" name="drugs[0].years" class="drug-years" min="0" value="0">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="input-group checkbox-group">
                        <input type="checkbox" id="visualExaggeration" name="visual_exaggeration">
                        <label for="visualExaggeration">
                            Show aggressive (visual) estimate
                            <span class="tooltip-trigger" aria-describedby="visualTooltip">(?)</span>
                        </label>
                        <div id="visualTooltip" class="tooltip" role="tooltip">Reduces the displayed age by an additional 5% for educational impact. This is not a clinical value.</div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">Calculate My Estimated Age</button>
                    <button type="reset" class="btn-secondary" id="resetBtn">Reset Form</button>
                </div>

                <div class="disclaimer">
                    <p><strong>Disclaimer:</strong> This tool provides a rough, non-diagnostic estimate only. It is not medical advice. Consult a qualified health professional for medical advice.</p>
                </div>
            </form>

            <div id="resultsPanel" class="results-panel" style="display: none;" aria-live="polite">
                <h2>Your Estimated Effective Age</h2>

                <div class="age-gauge">
                    <div class="gauge-labels">
                        <span id="chronologicalAgeDisplay">0</span>
                        <span>Chronological Age</span>
                        <span id="effectiveAgeDisplay">0</span>
                    </div>
                    <div class="gauge-bar">
                        <div class="gauge-fill" id="gaugeFill"></div>
                    </div>
                </div>

                <div class="results-breakdown">
                    <h3>Breakdown of Age Deductions</h3>
                    <ul id="breakdownList"></ul>
                    <p class="total-deduction">Total Deduction: <span id="totalDeduction">0</span> years</p>
                </div>

                <div class="risk-indicator" id="riskIndicator">
                    <h3>Risk Indicator</h3>
                    <p id="riskText"></p>
                </div>

                <!-- Google AdSense In-Article Ad -->
                <div class="ad-container">
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-your-publisher-id"
                         data-ad-slot="your-ad-slot-id"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>

                <div class="resources">
                    <h3>Resources & Support</h3>
                    <p>If you are concerned about your substance use, please seek professional help.</p>
                    <ul>
                        <li><a href="https://www.samhsa.gov/find-help/national-helpline" target="_blank" rel="noopener">SAMHSA National Helpline: 1-800-662-HELP (4357)</a></li>
                        <li><a href="https://www.cdc.gov/tobacco/quit_smoking/index.htm" target="_blank" rel="noopener">CDC Guide to Quitting Smoking</a></li>
                        <li><a href="https://www.niaaa.nih.gov/publications/brochures-and-fact-sheets/treatment-alcohol-problems-finding-and-getting-help" target="_blank" rel="noopener">NIAAA Alcohol Treatment Resources</a></li>
                    </ul>
                </div>
            </div>
        </main>

        <!-- Google AdSense Bottom Ad -->
        <div class="ad-container">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-your-publisher-id"
                 data-ad-slot="your-ad-slot-id"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>

        <footer>
            <div class="footer-links">
                <a href="#" id="privacyLink">Privacy Policy</a>
                <a href="#" id="termsLink">Terms of Use</a>
                <a href="#" id="contactLink">Contact</a>
            </div>
            <p>&copy; 2023 Effective Age Calculator. This tool provides estimates only and is not medical advice.</p>
        </footer>
    </div>

    <!-- Cookie Consent Banner -->
    <div class="cookie-consent" id="cookieConsent">
        <p>We use cookies to personalize content and ads, to provide social media features and to analyze our traffic. We also share information about your use of our site with our social media, advertising and analytics partners.</p>
        <div class="cookie-buttons">
            <button class="btn-primary" id="acceptCookies">Accept</button>
            <button class="btn-secondary" id="rejectCookies">Reject</button>
        </div>
    </div>

    <!-- Theme Toggle Button -->
    <div class="theme-toggle" id="themeToggle">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 2V4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 20V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M4.93 4.93L6.34 6.34" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M17.66 17.66L19.07 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M2 12H4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M20 12H22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M6.34 17.66L4.93 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M19.07 4.93L17.66 6.34" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('ageCalculatorForm');
            const resultsPanel = document.getElementById('resultsPanel');
            const smokingBadge = document.getElementById('smokingBadge');
            const smokingTypeSelect = document.getElementById('smokingType');
            const cigarettesGroup = document.getElementById('cigarettesGroup');
            const smokingYearsGroup = document.getElementById('smokingYearsGroup');
            const addDrugBtn = document.getElementById('addDrugBtn');
            const drugsSection = document.getElementById('drugsSection');
            const resetBtn = document.getElementById('resetBtn');
            const themeToggle = document.getElementById('themeToggle');
            const cookieConsent = document.getElementById('cookieConsent');
            const acceptCookies = document.getElementById('acceptCookies');
            const rejectCookies = document.getElementById('rejectCookies');
            const privacyLink = document.getElementById('privacyLink');
            const termsLink = document.getElementById('termsLink');
            let drugCount = 1;
            let currentTheme = 'light';

            // Check for saved theme preference or respect OS preference
            function initTheme() {
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    currentTheme = 'dark';
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                    currentTheme = 'light';
                }
            }

            // Toggle theme
            function toggleTheme() {
                if (currentTheme === 'light') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    currentTheme = 'dark';
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                    currentTheme = 'light';
                    localStorage.setItem('theme', 'light');
                }
            }

            // Check cookie consent
            function checkCookieConsent() {
                if (!localStorage.getItem('cookiesAccepted')) {
                    cookieConsent.style.display = 'block';
                }
            }

            // Multipliers for calculation (simplified client-side version)
            const multipliers = {
                smoking: {
                    cigarette: 0.5,
                    'e-cigarette': 0.1,
                    pipe: 0.4,
                    cigar: 0.4
                },
                alcohol: {
                    standard_drink_per_week: 0.05,
                    binge_episode_per_month: 0.25
                },
                drugs: {
                    cannabis: { daily: 0.07, weekly: 0.03, monthly: 0.01 },
                    cocaine: { daily: 0.3, weekly: 0.15, monthly: 0.05 },
                    amphetamines: { daily: 0.35, weekly: 0.17, monthly: 0.06 },
                    opioids: { daily: 0.4, weekly: 0.2, monthly: 0.07 },
                    mdma: { daily: 0.25, weekly: 0.12, monthly: 0.04 },
                    synthetic_cannabinoids: { daily: 0.45, weekly: 0.22, monthly: 0.08 }
                }
            };

            // Initialize theme and cookie consent
            initTheme();
            checkCookieConsent();

            // Theme toggle event
            themeToggle.addEventListener('click', toggleTheme);

            // Cookie consent events
            acceptCookies.addEventListener('click', function() {
                localStorage.setItem('cookiesAccepted', 'true');
                cookieConsent.style.display = 'none';
            });

            rejectCookies.addEventListener('click', function() {
                localStorage.setItem('cookiesAccepted', 'false');
                cookieConsent.style.display = 'none';
            });

            // Policy links
            privacyLink.addEventListener('click', function(e) {
                e.preventDefault();
                alert('Privacy Policy: We value your privacy and do not store any personal data. All calculations are performed locally in your browser. We use cookies only for basic functionality and analytics.');
            });

            termsLink.addEventListener('click', function(e) {
                e.preventDefault();
                alert('Terms of Use: This tool is for informational purposes only. Results are estimates and not medical advice. By using this tool, you agree that you are over 18 years of age and understand the limitations of this calculator.');
            });

            // Toggle smoking input fields based on type selection
            smokingTypeSelect.addEventListener('change', function() {
                const isSmoker = this.value !== '';
                cigarettesGroup.style.display = isSmoker ? 'block' : 'none';
                smokingYearsGroup.style.display = isSmoker ? 'block' : 'none';
                
                smokingBadge.style.display = isSmoker ? 'inline-flex' : 'none';
                if (!isSmoker) {
                    document.getElementById('smokingDeduction').textContent = '-0';
                }
            });

            // Dynamically update smoking badge on input change
            document.getElementById('cigarettesPerDay').addEventListener('input', updateSmokingBadge);
            document.getElementById('smokingYears').addEventListener('input', updateSmokingBadge);
            smokingTypeSelect.addEventListener('change', updateSmokingBadge);

            function updateSmokingBadge() {
                const type = smokingTypeSelect.value;
                const cigsPerDay = parseInt(document.getElementById('cigarettesPerDay').value) || 0;
                const years = parseInt(document.getElementById('smokingYears').value) || 0;

                if (type && cigsPerDay > 0 && years > 0) {
                    const packsPerDay = cigsPerDay / 20;
                    const packYears = packsPerDay * years;
                    const multiplier = multipliers.smoking[type] || 0.5;
                    const deductionEstimate = packYears * multiplier;
                    document.getElementById('smokingDeduction').textContent = `-${deductionEstimate.toFixed(1)}`;
                } else {
                    document.getElementById('smokingDeduction').textContent = '-0';
                }
            }

            // Add new drug entry
            addDrugBtn.addEventListener('click', function() {
                const newDrugEntry = document.createElement('div');
                newDrugEntry.className = 'drug-entry';
                newDrugEntry.innerHTML = `
                    <div class="input-group">
                        <label>Substance</label>
                        <select name="drugs[${drugCount}].name" class="drug-name">
                            <option value="cannabis">Cannabis (Marijuana)</option>
                            <option value="cocaine">Cocaine</option>
                            <option value="amphetamines">Amphetamines</option>
                            <option value="opioids">Opioids</option>
                            <option value="mdma">MDMA (Ecstasy)</option>
                            <option value="synthetic_cannabinoids">Synthetic Cannabinoids</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Frequency</label>
                        <select name="drugs[${drugCount}].frequency" class="drug-frequency">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Years of use</label>
                        <input type="number" name="drugs[${drugCount}].years" class="drug-years" min="0" value="0">
                    </div>
                    <button type="button" class="btn-secondary remove-drug-btn" style="margin-top: 0.5rem;">Remove</button>
                `;
                
                drugsSection.insertBefore(newDrugEntry, addDrugBtn);
                
                newDrugEntry.querySelector('.remove-drug-btn').addEventListener('click', function() {
                    drugsSection.removeChild(newDrugEntry);
                });
                
                drugCount++;
            });

            // Form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                form.classList.add('loading');
                
                const formData = new FormData(form);
                const payload = {
                    age: parseInt(formData.get('age')),
                    sex: formData.get('sex') || undefined,
                    visual_exaggeration: formData.get('visual_exaggeration') === 'on'
                };

                const smokingType = formData.get('smoking.type');
                if (smokingType) {
                    payload.smoking = {
                        type: smokingType,
                        cigarettes_per_day: parseInt(formData.get('smoking.cigarettes_per_day')) || 0,
                        years: parseInt(formData.get('smoking.years')) || 0
                    };
                }

                payload.alcohol = {
                    drinks_per_week: parseInt(formData.get('alcohol.drinks_per_week')) || 0,
                    binge_per_month: parseInt(formData.get('alcohol.binge_per_month')) || 0
                };

                const drugs = [];
                const drugEntries = document.querySelectorAll('.drug-entry');
                drugEntries.forEach(entry => {
                    const name = entry.querySelector('.drug-name').value;
                    const frequency = entry.querySelector('.drug-frequency').value;
                    const years = parseInt(entry.querySelector('.drug-years').value) || 0;
                    
                    if (years > 0) {
                        drugs.push({ name, frequency, years });
                    }
                });
                
                if (drugs.length > 0) {
                    payload.drugs = drugs;
                }

                // Simulate API call with client-side calculation
                setTimeout(() => {
                    const result = calculateResults(payload);
                    displayResults(result);
                    form.classList.remove('loading');
                }, 500);
            });

            // Calculate results (client-side simulation)
            function calculateResults(payload) {
                let totalDeduction = 0;
                const breakdown = {};

                // Calculate smoking deduction
                if (payload.smoking) {
                    const smoking = payload.smoking;
                    const packsPerDay = smoking.cigarettes_per_day / 20;
                    const packYears = packsPerDay * smoking.years;
                    const smokingDeduction = packYears * multipliers.smoking[smoking.type];
                    breakdown.smoking = smokingDeduction;
                    totalDeduction += smokingDeduction;
                }

                // Calculate alcohol deduction
                if (payload.alcohol) {
                    const alcohol = payload.alcohol;
                    const alcoholDeduction = 
                        (alcohol.drinks_per_week * multipliers.alcohol.standard_drink_per_week) +
                        (alcohol.binge_per_month * multipliers.alcohol.binge_episode_per_month);
                    breakdown.alcohol = alcoholDeduction;
                    totalDeduction += alcoholDeduction;
                }

                // Calculate drug deductions
                if (payload.drugs) {
                    payload.drugs.forEach(drug => {
                        const drugDeduction = multipliers.drugs[drug.name][drug.frequency] * drug.years;
                        breakdown[drug.name] = drugDeduction;
                        totalDeduction += drugDeduction;
                    });
                }

                const chronologicalAge = payload.age;
                const computedAge = Math.max(10, chronologicalAge - totalDeduction);
                const displayedAge = payload.visual_exaggeration ? computedAge * 0.95 : computedAge;

                return {
                    chronological_age: chronologicalAge,
                    computed_effective_age: computedAge,
                    displayed_effective_age: displayedAge,
                    total_deduction: totalDeduction,
                    deduction_breakdown: breakdown,
                    visual_exaggeration_applied: payload.visual_exaggeration
                };
            }

            // Display results
            function displayResults(data) {
                document.getElementById('chronologicalAgeDisplay').textContent = data.chronological_age;
                document.getElementById('effectiveAgeDisplay').textContent = data.displayed_effective_age.toFixed(1);
                
                const gaugeFill = document.getElementById('gaugeFill');
                const percentage = (data.displayed_effective_age / data.chronological_age) * 100;
                gaugeFill.style.width = `${Math.min(percentage, 100)}%`;
                
                const breakdownList = document.getElementById('breakdownList');
                breakdownList.innerHTML = '';
                
                if (Object.keys(data.deduction_breakdown).length === 0) {
                    breakdownList.innerHTML = '<li>No significant deductions calculated.</li>';
                } else {
                    for (const [category, deduction] of Object.entries(data.deduction_breakdown)) {
                        const li = document.createElement('li');
                        li.innerHTML = `<span>${formatCategoryName(category)}</span> <span>-${deduction.toFixed(1)} yrs</span>`;
                        breakdownList.appendChild(li);
                    }
                }
                
                document.getElementById('totalDeduction').textContent = data.total_deduction.toFixed(1);
                
                const riskIndicator = document.getElementById('riskIndicator');
                const riskText = document.getElementById('riskText');
                
                let riskLevel = 'low';
                let riskMessage = 'Your estimated biological age is close to your chronological age.';
                
                if (data.total_deduction > 5) {
                    riskLevel = 'high';
                    riskMessage = 'Your substance use is estimated to have a significant impact on your biological age.';
                } else if (data.total_deduction > 2) {
                    riskLevel = 'moderate';
                    riskMessage = 'Your substance use is estimated to have a moderate impact on your biological age.';
                }
                
                riskIndicator.className = `risk-indicator risk-${riskLevel}`;
                riskText.textContent = riskMessage;
                
                resultsPanel.style.display = 'block';
                resultsPanel.scrollIntoView({ behavior: 'smooth' });
            }

            // Helper function to format category names for display
            function formatCategoryName(category) {
                const names = {
                    'smoking': 'Smoking',
                    'alcohol': 'Alcohol',
                    'cannabis': 'Cannabis',
                    'cocaine': 'Cocaine',
                    'amphetamines': 'Amphetamines',
                    'opioids': 'Opioids',
                    'mdma': 'MDMA',
                    'synthetic_cannabinoids': 'Synthetic Cannabinoids'
                };
                return names[category] || category.charAt(0).toUpperCase() + category.slice(1);
            }

            // Reset form
            resetBtn.addEventListener('click', function() {
                resultsPanel.style.display = 'none';
                smokingBadge.style.display = 'none';
                document.getElementById('smokingDeduction').textContent = '-0';
                
                const drugEntries = document.querySelectorAll('.drug-entry');
                for (let i = 1; i < drugEntries.length; i++) {
                    drugsSection.removeChild(drugEntries[i]);
                }
                drugCount = 1;
            });
        });
    </script>
</body>
</html>
